{% extends 'base.html' %}
{% load static %}
{% load medi_report_tags %}
{% load bootstrap4 %}
{% load get_permissions %}
{% load cache %}
{% bootstrap_css %}
{% bootstrap_javascript jquery='full' %}
{% bootstrap_messages %}

{% block ExtraHead %}
    <link rel="stylesheet" href="{% static 'medicalreport/css/medicalreport.css' %}">
    <link rel="stylesheet" href="{% static 'css/library/library.css' %}">
    <link href="{% static 'css/bootstrap-datepicker.min.css' %}" rel="stylesheet"/>
    <link rel="stylesheet" href="{% static 'css/pretty-checkbox.min.css' %}">
{% endblock %}

{% block Content %}
    <div class="container">
        <div id="overlay"></div>
        {% cache 300 patient_info_top instruction %}
        <div class="container-fluid callout callout--top">
            {% patient_info %}
        </div>
        {% if instruction.type == 'SARS' %}
            <h1>Provisional copy of patient record</h1>
        {% else %}
            <h1>Provisional Report Contents</h1>
        {% endif %}
        {% endcache %}
        <form action="{% url 'medicalreport:update_report' instruction.id %}" method="post" id="medicalReportForm">
            {% csrf_token %}
            {% if not redaction.instruction_checked and show_alert %}
                {% cache 300 sensitive_information %}
                <div class="modal fade" id="form-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content sensitive-information-instructions alert-warning modal-warning-block">
                            <h6>Sensitive information instructions:</h6>
                            <ul>
                                <li>Do not include any history of sensitive conditions (e.g. sexually transmitted infections, terminations of pregnancy, domestic abuse) unless they have long term health implications and the patient consents to disclose such information.</li>
                                <li>The signing GP must check the report for any errors and remove any references to third parties before submitting a final report.</li>
                                <li>Do not include information about negative blood borne virus tests (HIV, Hepatitis B, Hepatitis C).</li>
                                <li>Do not include genetic test results unless there is a favourable test result stating that the patient has not inherited a condition.</li>
                            </ul>
                            <p>A full list of sensitive conditions (GP Summary Exclusion Code Lists) can be found<a id="here-link" href="#"> here.</a></p>
                            <div class="inst_chk">
                                <div class="pretty p-default right">
                                    {{ finalise_submit_form.instruction_checked }}
                                    <div class="state p-primary">
                                        <label>I understand</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="trud-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content sensitive-information-instructions">
                            <h6>Human readable conditions</h6>
                            <ul>
                                <li><a href="{% url 'medicalreport:trud_ivf' %}">IVF</a></li>
                                <li><a href="{% url 'medicalreport:trud_std' %}">STD</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                {% endcache %}
            {% endif %}
            <div class="row">
                <div class="col-md-6">
                    {% form_profile %}
                    {% form_medications %}
                    {% form_consultations %}
                    {% form_referrals %}
                </div>
                <div class="col-md-6">
                    {% form_significant_problems %}
                    {% form_allergies %}
                    {% form_bloods %}
                    {% form_attachments %}
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    {% form_addition_answers %}
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    {% form_comments %}
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 bg-white" style="background-clip: content-box">
                    <div class="row">
                        <div class="col-md-12 pt-3 pb-2 pr-0 pl-0">
                            <input type="hidden" name="event_flag" id="event_flag">
                            <div class="row">
                                <div class="col-md-6 pl-5">
                                    <button type="button" id="saveDraftButton" onclick="subMitMedicalReport('draft')"
                                        class="btn btn-primary w-50"><i class="fas fa-save"></i> Save Draft</button>
                                    <div class="row medicalreport-date">
                                        <div class="col-md-8 pl-0">
                                            last updated: {{ redaction.updated_at }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 pr-5">
                                    <button type="button" id="savePreviewButton" onclick="subMitMedicalReport('preview')"
                                            class="btn btn-info w-50 float-right">
                                        Preview and Submit &nbsp;<i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    {% cache 300 patient_info_modal instruction %}
    <a href="javascript:;" class="btn btn-primary" id="patient-info-open-modal">Instruction Information</a>
    <div class="patientInfo" id="patientInfo">
        {% patient_info %}
    </div>

    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg bg-info">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="container">
                        <div class="col-12 text-center mt-2">
                            <img src="{% static 'images/custom_images/loading.gif'%}" class="img-fluid">
                            <div class="col-12">&nbsp;</div>
                            <h4>Patient : <strong>{{ patient_full_name }}</strong></h4>
                            <h4 class="mt-2">The medical record or report will be generated soon.</h4>
                            <label class="text-danger mt-4">Please don't leave this page. Process is running ....</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% endcache %}

    <a href="javascript:;" class="btn btn-primary" id="report-toolbox-open-modal">Report Toolbox</a>
    <div class="report-toolbox-modal" id="report-toolbox-modal">
        {% include "library/report_toolbox_modal.html" %}
    </div>
    <form method="POST" action="{% url 'library:edit_library' event='add' %}" id="addWordForm">
        {% csrf_token %}
        {% include "library/add_word_modal.html" %}
    </form>
{% endblock %}

{% block Script %}
    <script src="{% static 'js/bootstrap-datepicker.min.js' %}"></script>
    <script src="{% static 'medicalreport/js/medicalreport.js' %}"></script>
    <script>
        $("#form-modal").modal({
            backdrop: 'static'
        });
        setInterval(function() {
          $("#alert-message").fadeOut('slow');
        }, 3000);
        $('#id_gp_practitioner').removeAttr('required');

        $('#id_prepared_and_signed_0').on('click', function () {
            $('#id_prepared_by').val('');
            $('#id_prepared_by').prop('readonly', true);
        });
        $('#id_prepared_and_signed_1').on('click', function () {
            $('#id_prepared_by').prop('readonly', false);
        });

        $('#patient-info-open-modal').on('click', function () {
           $('#patientInfo').toggle();
        });

        $('#report-toolbox-open-modal').on('click', function () {
           $('#report-toolbox-modal').toggle();
        });

        $('input:checkbox').on('change', function() {
            var xpath = $(this).val();
            var key = $(this).attr('key');

            if(Array.isArray(xpath)) {
                xpath = xpath[0];
            }

            if(Array.isArray(key)) {
                key = key[0];
            }
            $('input:checkbox').each( function() {
                if( $(this).attr('key') == key) {
                    $(this).prop('checked', this.checked);
                }
            });
            saveReport();

            $.ajax({
                url: "{% url 'library:manual_radact' %}",
                dataType: "json",
                data: {
                    instruction_id: {{ instruction.id }}, 
                    xpath: xpath,
                    key: key
                }
            }).done(function(response) {
                if (response['message'] == 'Error') {
                    create_alert('Something went wrong, please try again.', 'error');
                }
            }).fail(function() {
                create_alert('Something went wrong, please try again.', 'error');
            });
        });

        $('.finaliseChoice').css('font-size', 'large');

        $('#preparer').append($('#id_prepared_by'));
        $('#id_prepared_by').removeClass('form-control');

        $(".update_report_btn").on('click', function(event){
            event.preventDefault(); //prevent default action
            saveReport();
        });

        var t_id = null;
        $('#medicalReportForm').find('input, textarea').not('.form-input').on('change', function () {
            let form_save_delay = 10000;
            // remove previews timeout
            if(t_id){
                clearTimeout(t_id);
            }
            t_id = setTimeout(function () {
                saveReport();
            }, form_save_delay)
        });
        enable_submit_button();
        $('#id_prepared_and_signed_0').on('click', function () {
            enable_submit_button();
        });
        $('#id_prepared_and_signed_1').on('click', function () {
            enable_submit_button();
        });
        $('#id_prepared_by').on('change', function () {
            enable_submit_button();
        });
        $('#accept_disclaimer').on('change', function () {
            enable_submit_button();
        });
        $("input[type='checkbox'][name='instruction_checked']").click(function(){
            if($(this).is(":checked")){
                setTimeout(function(){ 
                    $("#form-modal").modal('hide');
                    saveReport(true);
                }, 600);
            }
        });

        $('#savePreviewButton').click( function() {
           $('#loadingModal').modal({
                backdrop: "static"
            }); 
        });

        $('#addWordForm').submit(function(e) {
            addWordLibrary();
            return false;
        });

        var timeoutId;
        $(".dropdown-options").hide();
        $(".highlight-library").hover(function() {
            if (!timeoutId) {
                var highlight_div = $(this);
                if (highlight_div.find('.bg-warning').length) {
                    timeoutId = window.setTimeout(function() {
                        timeoutId = null;
                        highlight_div.find('.dropdown-options').slideDown('fast');
                   }, 400);
                }
            }
        }, function () {
            if (timeoutId) {
                window.clearTimeout(timeoutId);
                timeoutId = null;
            }
            else {
               $(".dropdown-options").slideUp('fast');
            }
        });

        $(".highlight-redact").on("click", function(e) {
            e.preventDefault();
            var word_span = $(this).parent().parent().find("span.bg-warning");
            var word = word_span.text();
            var item = $(this).closest('.redaction-checkbox');
            var item_parent = $(this).closest('.callout');
            var header = item_parent.find('.callout__header').text();
            var idx = -1;
            var xpath = $(this).parent().data('xpath')
            item_parent.find('.redaction-checkbox').filter(function(index, obj) {
                    if (item.is($(obj))) {
                        idx = index;
                        return 1;
                    }
                });
            if(Array.isArray(xpath)) {
                xpath = xpath[0];
            }
            $.ajax({
                url: "{% url 'library:redact_word' %}",
                dataType: "json",
                data: {
                    word: word, 
                    instruction_id: {{ instruction.id }}, 
                    header: header, 
                    index: idx, 
                    content: item.html(),
                    xpath: xpath
                }
            }).done(function(response) {
                word_span.removeClass("bg-warning");
                word_span.addClass('bg-dark');
                create_alert('Redact complete.', 'success');
            }).fail(function() {
                create_alert('Something went wrong, please try again.', 'error');
            });
        });

        $(".highlight-replace").on("click", function(e) {
            e.preventDefault();
            var word_span = $(this).parent().parent().find("span.bg-warning");
            var word = word_span.text();
            var item = $(this).closest('.redaction-checkbox');
            var item_parent = $(this).closest('.callout');
            var header = item_parent.find('.callout__header').text();
            var idx = -1;
            var xpath = $(this).parent().data('xpath');
            item_parent.find('.redaction-checkbox').filter(function(index, obj) {
                if (item.is($(obj))) {
                    idx = index;
                    return 1;
                }
            });
            if(Array.isArray(xpath)) {
                xpath = xpath[0];
            }
            $.ajax({
                url: "{% url 'library:replace_word' %}",
                dataType: "json",
                data: {
                    word: word, 
                    instruction_id: {{ instruction.id }}, 
                    header: header, 
                    index: idx, 
                    xpath: xpath,
                    content: item.html(),
                }
            }).done(function(response) {
                if (response['message'] == 'Error') {
                    create_alert('Something went wrong, please try again.', 'error');
                } else {
                    word_span.text(response['replace_word']);
                    word_span.removeClass("bg-warning");
                    word_span.addClass('change-'+response['id']).addClass('text-danger');
                    create_alert('Replace complete.', 'success');
                }
            }).fail(function() {
                create_alert('Something went wrong, please try again.', 'error');
            });
        });

        $(".highlight-replaceall").on("click", function(e) {
            e.preventDefault();
            var word_span = $(this).parent().parent().find("span.bg-warning");
            var word = word_span.text();
            $.ajax({
                url: "{% url 'library:replace_allword' %}",
                dataType: "json",
                data: { word: word, instruction_id: {{ instruction.id }} }
            }).done(function(response) {
                if (response['message'] == 'Error') {
                    create_alert('Something went wrong, please try again.', 'error');
                } else {
                    $(".highlight-library .bg-warning").each(function(i, obj) {
                        if ($(obj).text() == word) {
                            $(obj).text(response['replace_word']);
                            $(obj).removeClass("bg-warning");
                            $(obj).addClass('change-'+response['id']).addClass('text-danger');
                        }
                    });
                }
                create_alert('ReplaceAll complete.', 'success');
            }).fail(function() {
                create_alert('Something went wrong, please try again.', 'error');
            });
        });

        $('#report-toolbox-modal-undolast').on('click', function(e) {
            e.preventDefault();
            $.ajax({
                url: "{% url 'library:undo_last' %}",
                dataType: "json",
                data: { instruction_id: {{ instruction.id }} }
            }).done(function(response) {
                if (response['message'] == 'Error') {
                    create_alert('Something went wrong, please try again.', 'error');
                } else {
                    if (response['action'] == 'Replace') {
                        $('span .dropdown-options').each( function() {
                            if( $(this).data('xpath') == response['xpath']) {
                                $(this).parent().html( response['text'] );
                            }
                        });
                    }   else if (response['action'] == 'ReplaceAll') {
                        $('span .dropdown-options').each( function() {
                            if( $(this).parent().find("span.text-danger").text() == response['new']) {
                                $(this).parent().find("span.text-danger").text( response['old'] ).removeClass().addClass('bg-warning');
                            }
                        });
                    }   else if (response['action'] == 'Redact') {
                        $('span .dropdown-options').each( function() {
                            if( $(this).data('xpath') == response['xpath']) {
                                $(this).removeClass('bg-dark');
                                $(this).parent().html( response['text'] );
                            }
                        });
                    }   else if (response['action'] == 'mRedact') {
                        $('input').each( function() {
                            if( $(this).val() == response['xpath']) {
                                $(this).prop('checked', false);
                            }
                        });
                    }   else if (response['action'] == 'rmRedact') {
                        $('input').each( function() {
                            if( $(this).val() == response['xpath']) {
                                $(this).prop('checked', true);
                            }
                        });
                    }
                    create_alert('Undo complete.', 'success');
                }
            }).fail(function() {
                create_alert('Something went wrong, please try again.', 'error');
            })
        });

        $('#report-toolbox-modal-undoall').click( function(e) {
            e.preventDefault();
            $.ajax({
                url: "{% url 'library:undo_all' %}",
                dataType: "json",
                data: { instruction_id: {{ instruction.id }} }
            }).done(function(response) {
                if (response['message'] == 'Error') {
                    create_alert('Something went wrong, please try again.', 'error');
                } else {
                    response.history.forEach( function(value) {
                        if (value.action == 'Replace') {
                            $('span .dropdown-options').each( function() {
                                if( $(this).data('xpath') == value.xpath) {
                                    $(this).parent().html( value.text );
                                }
                            });
                        }   else if (value.action == 'ReplaceAll') {
                            $('span .dropdown-options').each( function() {
                                if( $(this).parent().find("span.text-danger").text() == value.new) {
                                    $(this).parent().find("span.text-danger").text( value.old ).removeClass().addClass('bg-warning');
                                }
                            });
                        }   else if (value.action == 'Redact') {
                            $('span .dropdown-options').each( function() {
                                if( $(this).data('xpath') == value.xpath) {
                                    $(this).removeClass('bg-dark');
                                    $(this).parent().html( value.text );
                                }
                            });
                        }   else if (value.action == 'mRedact') {
                            $('input').each( function() {
                                if( $(this).val() == value.xpath) {
                                    $(this).prop('checked', false);
                                }
                            });
                        }   else if (value.action == 'rmRedact') {
                            $('input').each( function() {
                                if( $(this).val() == value.xpath) {
                                    $(this).prop('checked', true);
                                }
                            });
                        }
                    });
                    create_alert('Undo All complete.', 'success');
                }
            }).fail(function() {
                create_alert('Something went wrong, please try again.', 'error');
            })
        });

        $('#here-link').click(function(e) {
            e.preventDefault();
            $('#trud-modal').modal('show');
        });
    </script>
{% endblock %}
