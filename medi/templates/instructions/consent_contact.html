{% extends 'base.html' %}
{% load bootstrap4 %}
{% load static %}
{% bootstrap_css %}
{% bootstrap_javascript jquery='full' %}
{% bootstrap_messages %}


{% block ExtraHead %}
    <link href="{% static 'css/select2.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'css/bootstrap-datepicker.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'css/style.css' %}" rel="stylesheet"/>
    <link href="{% static 'css/instructions/consent_contact.css' %}" rel="stylesheet"/>
    <link rel="stylesheet" href="{% static 'assets/kartik-v-boostrap-fileinput/css/fileinput.css' %}">
    <link rel="stylesheet" href="{% static 'assets/kartik-v-boostrap-fileinput/themes/explorer-fas/theme.css' %}">
    <script src="{% static 'assets/kartik-v-boostrap-fileinput/js/fileinput.js' %}"></script>
    <script src="{% static 'assets/kartik-v-boostrap-fileinput/js/locales/LANG.js' %}"></script>
    <script src="{% static 'assets/kartik-v-boostrap-fileinput/themes/fas/theme.js' %}"></script>
{% endblock %}

{% block Content %}
    <div class="card-deck instruction">
        <div class="col-md-12">
            <div class="card patientForm">
                <div class="card-header">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Patient</h5>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="row col-md-5">
                            <div class="col-md-2 rowTitle">Name*:</div>
                            {% bootstrap_field patient_form.title size='small' form_group_class='form-group col-md-2 p-0'%}
                            {% bootstrap_field patient_form.first_name size='small' form_group_class='form-group-plaintext  col-md-4 px-2' %}
                            {% bootstrap_field patient_form.last_name size='small' form_group_class='form-group col-md-4 px-1' %}
                        </div>
                        <div class="row offset-md-1 col-md-6">
                            <div class="col-md-2 rowTitle">Date of Birth*:</div>
                            {% bootstrap_field patient_form.date_of_birth size='small' form_group_class='form-group col-md-10 pt-4 mt-1 dob' show_label=False %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="row col-md-5">
                            <div class="col-md-2 rowTitle">Address*:</div>
                            {% bootstrap_field patient_form.address_postcode size='small' form_group_class='form-group col-md-4 p-0 ' %}
                            {% bootstrap_field patient_form.address_name_number size='small' form_group_class='form-group col-md-6 px-1' %}
                        </div>
                        <div class="row offset-md-1 col-md-6">
                            <div class="col-md-2 rowTitle">NHS #:</div>
                            {% bootstrap_field patient_form.nhs_number size='small' form_group_class='form-group col-md-10 pt-4 mt-1' show_label=False placeholder='' %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-12 mt-4">
            <div class="card">
                <div class="card-header"><h5>Consent and contact information</h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="row offset-md-1 col-md-10">
                                <h6>SARS Request</h6>
                            </div>
                            <div class="row offset-md-1 col-md-10 mt-4">
                                <h6>Required if initiated via third party</h6>
                            </div>
                            <div class="row mt-2">
                               <div class="offset-md-1 col-md-10 mt-4">
                                    <div class="form-group">
                                        <div class="file-loading">
                                            <input type="file" id="id_sars_consent" name="sars_consent" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="row offset-md-1 col-md-10">
                                <h6>MDX Dual Consent</h6>
                            </div>
                            <div class="row offset-md-1 col-md-10 mt-1">
                                <button class="btn btn-primary btn-lg w-100" type="" id="downloadBtn">
                                    Download Pre-Populated Consent Form
                                </button>
                            </div>
                            <div class="row mt-4">
                                <div class="offset-md-1 col-md-10 mt-1">
                                    <div class="form-group">
                                        <div class="file-loading">
                                            <input type="file" id="id_mdx_dual_consent" name="mdx_dual_consent" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                       </div>
                        <div class="col-md-4">
                            <div class="row offset-md-1 col-md-10">
                                <h6>Contact information</h6>
                            </div>
                            <div class="row mt-4">
                                <div class="col-md-3 rowTitle">Email</div>
                                {% bootstrap_field patient_form.patient_input_email size='small' form_group_class='col-md-8' show_label=false placeholder='' %}
                            </div>
                            <div class="row mt-4">
                                <div class="col-md-3 rowTitle">Confirm Email</div>
                                <div class="col-md-8"><input type="email" id="confirm_email" class="form-control form-control-sm" /></div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-md-3 rowTitle">Mobile Phone</div>
                               {% bootstrap_field patient_form.telephone_mobile size='small' form_group_class='col-md-8' show_label=false placeholder='' %}
                            </div>
                            <div class="row mt-4">
                                <div class="col-md-3 rowTitle">Alternate Phone(optional)</div>
                                {% bootstrap_field patient_form.alternate_phone size='small' form_group_class='col-md-8' show_label=false placeholder='' %}
                            </div>
                       </div>
                    </div>
                </div>
            </div>
        </div>
   </div>
   <div id="emailDialog1" class="emailModal well">
       <p>That doesn't look like a valid email address</p>
       <button class="emailDialog1_close rightBtn btn btn-sm btn-default">Close</button>
   </div>
   <div id="emailDialog2" class="emailModal well">
        <p>Those email addresses don't match</p>
        <button class="emailDialog2_close rightBtn btn btn-sm btn-default">Close</button>
    </div>
    {% if request.user.type == 'GP' %}
        <div class="row ml-1 mt-4 ">
            <div class="col-md-12">
                <a href="{% url 'medicalreport:set_patient_emis_number' instruction_id=instruction.id %}" class="btn btn-primary btn-lg" id="backButton"><i class="fas fa-chevron-left"></i > Go back</a>
                <a href="{% url 'medicalreport:set_patient_emis_number' instruction_id=instruction.id %}"
                   class="btn btn-primary btn-lg" id="reportBtn">Proceed to Report <i class="fas fa-chevron-right"></i>
                </a>
                <a href="{% url 'instructions:view_pipeline' %}" class="btn btn-primary btn-lg rightBtn mr-4" id="saveBtn">Save and Return to Pipeline</a>
                <a href="#" class="btn btn-danger btn-lg rightBtn mr-1" id="rejectBtn">Reject Instruction</a>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block Script %}
    <!-- Include jQuery Popup Overlay -->
    <script src="{% static 'js/jquery.popupoverlay.js' %}"></script>
    <script>
    $(document).ready(function () {
        var isPopup = false;
        var validations ={
            email: [/^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/, 'Please enter a valid email address']
        };
        $(".emailModal").popup({
            transition: 'all 0.3s',
            scrolllock: true,
            onclose: function() {
                isPopup = false;
            }
        });
        $('.patientForm input').attr('readonly', true);
        $("#id_sars_consent").fileinput({
            theme: 'fas',
            showUpload: false,
        });
        $("#id_mdx_dual_consent").fileinput({
            theme: 'fas',
            showUpload: false,
        });
        $('#id_patient_input_email').blur(function(){
            validation = new RegExp(validations['email'][0]);
            if ($('#id_patient_input_email').val() !='' && !validation.test(this.value) && !isPopup){
                isPopup = true;
                // If the validation fails then we show the custom error message
                setTimeout(function(){$("#emailDialog1").popup('show')}, 500);
            }
        });
        $('#confirm_email').blur(function(){
            if ($('#confirm_email').val() !='' && $('#confirm_email').val() != $('#id_patient_input_email').val() && !isPopup){
                isPopup = true;
                // If the validation fails then we show the custom error message
                setTimeout(function(){$("#emailDialog2").popup('show')}, 500)
            }
        });
    });
    </script>

{% endblock %}